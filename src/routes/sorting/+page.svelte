<script lang="ts">
  import { onMount } from 'svelte'
  import { GPUSort } from '../../lib/GPUSort/GPUSort'

  onMount(async () => {
    const adapter = (await window.navigator.gpu.requestAdapter())!
    const device = await adapter.requestDevice()
    const gpuSort = new GPUSort(device)

    const array = new Uint32Array([
      7850, 11475, 16878, 19565, 19619, 19647, 27922, 28003, 29064, 30562, 31613, 35483, 48089, 52278, 59844, 60813,
      64952, 70540, 72416, 73754, 75007, 78348, 78937, 79116, 83136, 83183, 85151, 92577, 94531, 99665, 102009, 106155,
      110653, 112202, 115599, 119272, 121264, 124767, 131544, 134364, 137971, 139031, 142961, 144160, 148222, 152420,
      154623, 168438, 175667, 179049, 181363, 186314, 187045, 189525, 194806, 199542, 203808, 204304, 220388, 220689,
      221617, 225382, 226628, 233215, 234756, 239872, 241575, 242388, 248360, 249375, 249544, 250858, 251812, 252847,
      255588, 255625, 287225, 289540, 291121, 291849, 302460, 305019, 306353, 315309, 321777, 327321, 329654, 336762,
      337598, 340680, 351255, 355206, 362012, 374305, 388293, 396403, 406122, 407121, 413301, 418569, 419529, 421536,
      426960, 436996, 442394, 446646, 446924, 447536, 449426, 449788, 454112, 454685, 458747, 462826, 466943, 474611,
      483139, 485182, 486548, 487780, 487898, 489437, 508477, 510088, 511173, 512450, 513792, 522102, 528405, 528674,
      530113, 530912, 533568, 535122, 535898, 546687, 546750, 550976, 554963, 574805, 575099, 578924, 582593, 584853,
      585612, 586570, 588657, 593760, 593801, 594729, 604040, 609055, 616574, 619705, 622403, 622866, 625811, 627636,
      635716, 635807, 637048, 639811, 642406, 643889, 647082, 648035, 652209, 652686, 654039, 654695, 657521, 663976,
      666018, 668614, 670063, 675798, 684761, 691501, 706244, 708841, 709434, 712816, 714134, 716543, 731814, 735548,
      737224, 739300, 753187, 753392, 755030, 755405, 759932, 761223, 764739, 771734, 774371, 776050, 780769, 787660,
      789154, 789229, 791750, 791919, 792147, 792985, 797479, 805920, 806022, 808332, 808604, 811504, 815362, 818885,
      828431, 829765, 833183, 836153, 843202, 848190, 850512, 851127, 853921, 872567, 875191, 884070, 887540, 894554,
      905447, 908607, 912443, 913916, 915585, 920480, 923090, 923590, 923677, 926868, 928093, 950358, 953868, 956153,
      959732, 961928, 970902, 973593, 975775, 976471, 978103, 983026, 985850, 990012, 990145, 994294, 995821, 997329
    ]) // size 256

    // const array = new Float32Array([
    //   903, 570, 89, 738, 556, 551, 244, 61, 18, 594, 922, 120, 19, 193, 256, 434, 810, 363, 217, 1, 559, 191, 693, 612,
    //   119, 638, 916, 739, 637, 723, 1000, 278, 234, 871, 403, 776, 123, 332, 87, 640, 277, 653, 21, 22, 489, 427, 60,
    //   211, 518, 933, 166, 754, 655, 742, 557, 32, 17, 710, 541, 749, 658, 345, 473, 471, 110, 183, 880, 690, 282, 828,
    //   529, 85, 429, 202, 971, 64, 500, 195, 520, 806, 888, 102, 274, 616, 431, 352, 351, 911, 775, 28, 285, 52, 226,
    //   308, 484, 377, 192, 398, 976, 129, 179, 717, 20, 925, 162, 83, 815, 35, 336, 369, 947, 220, 676, 455, 292, 56,
    //   639, 780, 959, 865, 213, 293, 706, 68, 207, 371, 470, 899, 989, 975, 48, 315, 757, 43, 691, 573, 408, 722, 635,
    //   770, 368, 465, 883, 281, 255, 709, 313, 344, 787, 951, 411, 228, 837, 33, 734, 952, 530, 571, 692, 370, 111, 320,
    //   832, 26, 260, 65, 177, 547, 981, 566, 817, 707, 894, 750, 425, 527, 215, 578, 422, 678, 200, 464, 233, 960, 771,
    //   124, 218, 312, 113, 843, 534, 550, 136, 299, 160, 803, 3, 624, 814, 439, 574, 390, 131, 270, 992, 546, 679, 5,
    //   613, 54, 876, 406, 905, 766, 839, 584, 649, 355, 767, 307, 991, 414, 127, 721, 276, 341, 878, 855, 697, 339, 483,
    //   194, 802, 126, 314, 252, 940, 644, 387, 909, 84, 248, 844, 306, 643, 463, 444, 145, 820, 258, 116, 866, 593, 509,
    //   650, 953, 526, 945, 203, 833, 949, 310, 583, 773, 384, 615, 881, 701, 714, 34, 606, 246, 46, 631, 901, 896, 791,
    //   416, 208, 686, 576, 452, 231, 156, 968, 934, 269, 58, 347, 946, 55, 219, 488, 449, 853, 562, 438, 372, 950, 621,
    //   236, 158, 485, 962, 772, 63, 829, 99, 447, 887, 958, 836, 396, 926, 603, 824, 309, 778, 331, 383, 462, 507, 860,
    //   182, 906, 756, 404, 376, 197, 552, 581, 415, 42, 382, 682, 385, 13, 505, 736, 872, 782, 266, 443, 180, 879, 497,
    //   467, 146, 797, 725, 694, 210, 316, 745, 977, 966, 964, 825, 931, 365, 941, 700, 338, 103, 648, 394, 743, 237, 993,
    //   189, 240, 988, 253, 395, 62, 450, 892, 768, 251, 504, 987, 699, 468, 57, 696, 108, 451, 151, 670, 342, 250, 346,
    //   375, 674, 115, 286, 963, 513, 763, 133, 511, 77, 877, 752, 432, 558, 176, 294, 915, 656, 641, 955, 727, 297, 542,
    //   323, 172, 544, 324, 348, 969, 660, 491, 618, 418, 740, 868, 765, 201, 746, 82, 728, 646, 433, 918, 243, 67, 985,
    //   224, 751, 229, 822, 886, 93, 109, 567, 873, 645, 633, 95, 170, 420, 741, 672, 914, 948, 168, 235, 107, 482, 288,
    //   978, 788, 73, 555, 835, 818, 498, 862, 353, 792, 469, 515, 689, 76, 840, 239, 262, 764, 72, 834, 921, 247, 50, 38,
    //   330, 289, 726, 121, 96, 983, 929, 614, 69, 517, 327, 974, 186, 852, 524, 516, 549, 287, 565, 939, 503, 419, 257,
    //   391, 86, 577, 777
    // ]) // size 512

    const bufArray = device.createBuffer({
      label: '+page bufArray Buffer',
      size: array.byteLength,
      usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC | GPUBufferUsage.COPY_DST
    })

    device.queue.writeBuffer(bufArray, 0, array)

    const bufReadArray = device.createBuffer({
      label: '+page bufReadArray Buffer',
      size: array.byteLength,
      usage: GPUBufferUsage.MAP_READ | GPUBufferUsage.COPY_DST
    })

    console.log('sort start')
    gpuSort.sort(bufArray)
    console.log('sort end')

    let encoder = device.createCommandEncoder()
    encoder.copyBufferToBuffer(bufArray, 0, bufReadArray, 0, array.byteLength)
    device.queue.submit([encoder.finish()])

    await bufReadArray.mapAsync(GPUMapMode.READ)
    const readArray = new Uint32Array(bufReadArray.getMappedRange())
    console.log(readArray)

    function isValid(array, resultArray) {
      const sortedInputArray = [...array].sort((a, b) => a - b)
      for (let i = 0; i < array.length; i++) {
        if (resultArray[i] != sortedInputArray[i]) {
          return false
        }
      }
      return true
    }
    console.log(isValid(array, readArray))
  })
</script>
